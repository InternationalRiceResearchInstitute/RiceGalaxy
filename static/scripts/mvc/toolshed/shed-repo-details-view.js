define([ "toolshed/repository-details-model" ], function() {
    var ToolShedRepositoryView = Backbone.View.extend({
        el: "#center",
        initialize: function(shed, repository) {
            console.log(arguments);
            this.model = new toolshed_model.RepositoryCollection(), this.listenTo(this.model, "sync", this.render), 
            shed = shed.replace(/\//g, "%2f"), this.model.url += "?tool_shed_url=" + shed + "&repository_id=" + repository, 
            this.model.tool_shed = shed, this.model.category = repository, this.model.fetch();
        },
        render: function(options) {
            console.log("render cat"), this.options = _.extend(this.options, options);
            var repo_details_template = this.templateRepoDetails;
            console.log(this.model.models), this.$el.html(repo_details_template({
                category: this.model.models[0],
                tool_shed: this.model.tool_shed
            })), $("#center").css("overflow", "auto");
        },
        templateRepoDetails: _.template([ '<div class="tab-pane" id="repository_details" data-shedurl="<%= tool_shed_url %>" data-tsrid="<%= current_metadata.repository.id %>">', '<h2 style="font-weight: normal;">Repository information for <strong><%= repository.name %></strong> from <strong><%= repository.owner %></strong></h2>', '<form id="repository_installation" name="install_repository" method="post" action="">', '<input type="hidden" id="repositories" name="<%= current_metadata.repository.id %>" value="ID" />', '<input type="hidden" id="tool_shed_url" name="tool_shed_url" value="<%= tool_shed_url %>" />', '<div class="toolForm">', '<div class="toolFormTitle">Changeset</div>', '<div class="toolFormBody changeset">', '<select id="changeset" name="changeset" style="margin: 5px;">', "<% _.each(Object.keys(repository.metadata), function(changeset) { %>", '<% if (changeset == current_changeset) { var selected = "selected "; } else { var selected = ""; } %>', '<option <%= selected %>data-changeset="<%= changeset %>" value="<%= changeset.split(":")[1] %>"><%= changeset %></option>', "<% }); %>", "</select>", '<input class="btn btn-primary preview-button" data-tsrid="<%= current_metadata.repository.id %>" type="submit" id="install_repository" name="install_repository" value="Install this revision now" />', '<input class="btn btn-primary preview-button" type="button" id="queue_install" name="queue_install" value="Install this revision later" />', '<div class="toolParamHelp" style="clear: both;">Please select a revision and review the settings below before installing.</div>', "</div>", "</div>", "<%= shed_tool_conf %>", '<div class="toolFormTitle">Dependencies of this repository at revision <strong id="current_changeset"><%= current_changeset %></strong></div>', '<div class="toolFormBody">', "<% if (current_metadata.has_repository_dependencies) { %>", '<p id="install_repository_dependencies_checkbox">', '<input type="checkbox" checked id="install_repository_dependencies" />', '<label for="install_repository_dependencies">Install repository dependencies</label>', "</p>", "<% current_metadata.repository_dependency_template = repository_dependency_template; %>", '<div class="tables container-table" id="repository_dependencies">', '<div class="expandLink">', '<a class="toggle_folder" data_target="repository_dependencies_table">', "Repository dependencies &ndash; <em>installation of these additional repositories is required</em>", "</a>", "</div>", "<%= repository_dependencies_template(current_metadata) %>", "</div>", "<% } %>", "<% if (current_metadata.includes_tool_dependencies) { %>", '<p id="install_resolver_dependencies_checkbox">', '<input type="checkbox" checked id="install_resolver_dependencies" />', '<label for="install_resolver_dependencies">Install resolver dependencies</label>', "</p>", '<p id="install_tool_dependencies_checkbox">', '<input type="checkbox" checked id="install_tool_dependencies" />', '<label for="install_tool_dependencies">Install tool dependencies</label>', "</p>", '<div class="tables container-table" id="tool_dependencies">', '<div class="expandLink">', '<a class="toggle_folder" data_target="tool_dependencies_table">', "Tool dependencies &ndash; <em>repository tools require handling of these dependencies</em>", "</a>", "</div>", '<table class="tables container-table" id="tool_dependencies_table" border="0" cellpadding="2" cellspacing="2" width="100%">', "<thead>", '<tr style="display: table-row;" class="datasetRow" parent="0" id="libraryItem-rt-f9cad7b01a472135">', '<th style="padding-left: 40px;">Name</th>', "<th>Version</th>", "<th>Type</th>", "</tr>", "</thead>", '<tbody id="tool_deps">', "<% _.each(tool_dependencies[current_changeset], function(dependency) { %>", '<tr class="datasetRow tool_dependency_row" style="display: table-row;">', '<td style="padding-left: 40px;">', "<%= dependency.name %></td>", "<td><%= dependency.version %></td>", "<td><%= dependency.type %></td>", "</tr>", "<% }); %>", "</tbody>", "</table>", "</div>", "<% } %>", "<% if (current_metadata.includes_tools_for_display_in_tool_panel) { %>", '<div class="tables container-table" id="tools_toggle">', '<div class="expandLink">', '<a class="toggle_folder" data_target="valid_tools">', "Valid tools &ndash; <em>click the name to preview the tool and use the pop-up menu to inspect all metadata</em>", "</a>", "</div>", '<table class="tables container-table" id="valid_tools" border="0" cellpadding="2" cellspacing="2" width="100%">', "<thead>", '<tr style="display: table-row;" class="datasetRow" parent="0" id="libraryItem-rt-f9cad7b01a472135">', '<th style="padding-left: 40px;">Name</th>', "<th>Description</th>", "<th>Version</th>", "<th><%= tps_template_global_select({tps: panel_section_dict}) %></tr>", "</thead>", '<tbody id="tools_in_repo">', "<% _.each(tools[current_changeset], function(tool) { %>", '<tr id="libraryItem-<%= tool.clean %>" class="tool_row" style="display: table-row;" style="width: 15%">', '<td style="padding-left: 40px;">', '<div id="tool-<%= tool.clean %>" class="menubutton split popup" style="float: left;">', '<a class="tool_form view-info" data-toggle="modal" data-target="toolform_<%= tool.clean %>" data-clean="<%= tool.clean %>" data-guid="<%= tool.guid %>" data-name="<%= tool.name %>" data-desc="<%= tool.description %>"><%= tool.name %></a>', "</div>", "</td>", "<td><%= tool.description %></td>", '<td style="width: 15%"><%= tool.version %></td>', '<td style="width: 35%" id="tool_tps_<%= tool.clean %>">', "<%= tps_template_tool_select({tool: tool, tps: panel_section_dict}) %>", "</td>", "</tr>", "<% }); %>", "</tbody>", "</table>", "</div>", "<% } %>", "</div>", "</form>", "</div>" ].join("")),
        templateRepoDependencies: _.template([ '<div class="tables container-table" id="repository_dependencies_table">', '<span class="repository_dependency_row"><p>Repository installation requires the following:</p></span>', '<ul id="repository_deps">', "<% if (has_repository_dependencies) { %>", "<% _.each(repository_dependencies, function(dependency) { %>", "<% dependency.repository_dependency_template = repository_dependency_template; %>", "<%= repository_dependency_template(dependency) %>", "<% }); %>", "<% } %>", "</ul>", "</div>" ].join("")),
        templateRepoDependency: _.template([ '<li id="metadata_<%= id %>" class="datasetRow repository_dependency_row" style="display: table-row;">', "Repository <b><%= repository.name %></b> revision <b><%= changeset_revision %></b> owned by <b><%= repository.owner %></b>", "</li>", "<% if (has_repository_dependencies) { %>", "<% _.each(repository_dependencies, function(dependency) { %>", "<% dependency.repository_dependency_template = repository_dependency_template; %>", '<li id="repository_<%= id %>_deps">', "<%= repository_dependency_template(dependency) %>", "</li>", "<% }); %>", "<% } %>" ].join("")),
        templateShedToolConf: _.template([ '<div class="toolFormTitle">Shed tool configuration file:</div>', '<div class="toolFormBody">', '<div class="form-row">', "<%= stc_html %>", '<div class="toolParamHelp" style="clear: both;">Select the file whose <b>tool_path</b> setting you want used for installing repositories.</div>', "</div>" ].join("")),
        templateToolDependency: _.template([ "<% if (has_repository_dependencies) { %>", "<% _.each(repository_dependencies, function(dependency) { %>", "<% if (dependency.includes_tool_dependencies) { %>", "<% dependency.tool_dependency_template = tool_dependency_template %>", "<%= tool_dependency_template(dependency) %>", "<% } %>", "<% }); %>", "<% } %>" ].join("")),
        templateGlobalSectionCreate: _.template([ '<div id="tool_panel_section">', '<div class="toolFormTitle">Tool Panel Section</div>', '<div class="toolFormBody">', '<div class="form-row" id="new_tps">', '<input id="new_tool_panel_section" name="new_tool_panel_section" type="textfield" value="" size="40"/>', '<input class="btn btn-primary" type="button" id="select_existing" value="Select existing" />', '<div class="toolParamHelp" style="clear: both;">', "Add a new tool panel section to contain the installed tools (optional).", "</div>", "</div>", "</div>", "</div>" ].join("")),
        templateGlobalSectionselect: _.template([ '<div id="tool_panel_section">', '<div class="toolFormTitle">Tool Panel Section</div>', '<div class="toolFormBody">', '<div class="tab-pane" id="select_tps">', '<select name="<%= name %>" id="<%= tps.id %>">', "<%= tps_select_options({sections: tps.sections}) %>", "</select>", '<input class="btn btn-primary" type="button" id="create_new" value="Create new" />', '<div class="toolParamHelp" style="clear: both;">', "Select an existing tool panel section to contain the installed tools (optional).", "</div>", "</div>", "</div>", "</div>" ].join("")),
        templateToolSectionCreate: _.template([ '<div id="new_tps_<%= tool.clean %>" data-clean="<%= tool.clean %>" class="form-row">', '<input data-toolguid="<%= tool.guid %>" class="tool_panel_section_picker" size="40" name="new_tool_panel_section" id="new_tool_panel_section_<%= tool.clean %>" type="text">', '<input id="per_tool_select_<%= tool.clean %>" class="btn btn-primary" data-toolguid="<%= tool.guid %>" value="Select existing" id="select_existing_<%= tool.clean %>" type="button">', "</div>" ].join("")),
        templateToolSectionCreate: _.template([ '<div id="select_tps_<%= tool.clean %>" data-clean="<%= tool.clean %>" class="tps_creator">', '<select default="active" style="width: 30em;" data-toolguid="<%= tool.guid %>" class="tool_panel_section_picker" name="tool_panel_section_id" id="tool_panel_section_select_<%= tool.clean %>">', "<%= tps_select_options({sections: tps.sections}) %>", "</select>", '<input id="per_tool_create_<%= tool.clean %>" data-clean="<%= tool.clean %>" class="btn btn-primary create-tps-button" data-toolguid="<%= tool.guid %>" value="Create new" id="create_new_<%= tool.clean %>" type="button">', '<div style="clear: both;" class="toolParamHelp"></div>', "</div>" ].join("")),
        templatePanelSelectOptions: _.template([ "<% _.each(sections, function(section) { %>", '<option value="<%= section.id %>"><%= section.name %></option>', "<% }); %>" ].join(""))
    });
    return {
        RepoDetails: ToolShedRepositoryView
    };
});