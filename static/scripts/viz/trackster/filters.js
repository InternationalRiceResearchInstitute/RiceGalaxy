define(["libs/underscore"],function(a){var b=a.extend,c=function(a){this.manager=null,this.name=a.name,this.index=a.index,this.tool_id=a.tool_id,this.tool_exp_name=a.tool_exp_name};b(c.prototype,{to_dict:function(){return{name:this.name,index:this.index,tool_id:this.tool_id,tool_exp_name:this.tool_exp_name}}});var d=function(a,b,c){return $("<a/>").attr("href","javascript:void(0);").attr("title",a).addClass("icon-button").addClass(b).tooltip().click(c)},e=function(a){c.call(this,a),this.low="low"in a?a.low:-Number.MAX_VALUE,this.high="high"in a?a.high:Number.MAX_VALUE,this.min="min"in a?a.min:Number.MAX_VALUE,this.max="max"in a?a.max:-Number.MAX_VALUE,this.container=null,this.slider=null,this.slider_label=null;var b=function(a,b,c){a.click(function(){var a=b.text(),d=parseFloat(c.slider("option","max")),e=1>=d?4:1e6>=d?d.toString().length:6,f=!1,g=$(this).parents(".slider-row");g.addClass("input"),c.slider("option","values")&&(e=2*e+1,f=!0),b.text(""),$("<input type='text'/>").attr("size",e).attr("maxlength",e).attr("value",a).appendTo(b).focus().select().click(function(a){a.stopPropagation()}).blur(function(){$(this).remove(),b.text(a),g.removeClass("input")}).keyup(function(a){if(27===a.keyCode)$(this).trigger("blur");else if(13===a.keyCode){var b=c.slider("option","min"),d=c.slider("option","max"),e=function(a){return isNaN(a)||a>d||b>a},h=$(this).val();if(f){if(h=h.split("-"),h=[parseFloat(h[0]),parseFloat(h[1])],e(h[0])||e(h[1]))return alert("Parameter value must be in the range ["+b+"-"+d+"]"),$(this)}else if(h=parseFloat(h),e(h))return alert("Parameter value must be in the range ["+b+"-"+d+"]"),$(this);c.slider(f?"values":"value",h),g.removeClass("input")}})})},e=this;e.parent_div=$("<div/>").addClass("filter-row slider-row");var f=$("<div/>").addClass("elt-label").appendTo(e.parent_div),g=($("<span/>").addClass("slider-name").text(e.name+"  ").appendTo(f),$("<span/>").text(this.low+"-"+this.high)),h=$("<span/>").addClass("slider-value").appendTo(f).append("[").append(g).append("]");e.values_span=g;var i=$("<div/>").addClass("slider").appendTo(e.parent_div);e.control_element=$("<div/>").attr("id",e.name+"-filter-control").appendTo(i),e.control_element.slider({range:!0,min:this.min,max:this.max,step:this.get_slider_step(this.min,this.max),values:[this.low,this.high],slide:function(a,b){e.slide(a,b)},change:function(a,b){e.control_element.slider("option","slide").call(e.control_element,a,b)}}),e.slider=e.control_element,e.slider_label=g,b(h,g,e.control_element);var j=$("<div/>").addClass("display-controls").appendTo(e.parent_div);this.transparency_icon=d("Use filter for data transparency","layer-transparent",function(){e.manager.alpha_filter!==e?(e.manager.alpha_filter=e,e.manager.parent_div.find(".layer-transparent").removeClass("active").hide(),e.transparency_icon.addClass("active").show()):(e.manager.alpha_filter=null,e.transparency_icon.removeClass("active")),e.manager.track.request_draw({force:!0,clear_after:!0})}).appendTo(j).hide(),this.height_icon=d("Use filter for data height","arrow-resize-090",function(){e.manager.height_filter!==e?(e.manager.height_filter=e,e.manager.parent_div.find(".arrow-resize-090").removeClass("active").hide(),e.height_icon.addClass("active").show()):(e.manager.height_filter=null,e.height_icon.removeClass("active")),e.manager.track.request_draw({force:!0,clear_after:!0})}).appendTo(j).hide(),e.parent_div.hover(function(){e.transparency_icon.show(),e.height_icon.show()},function(){e.manager.alpha_filter!==e&&e.transparency_icon.hide(),e.manager.height_filter!==e&&e.height_icon.hide()}),$("<div style='clear: both;'/>").appendTo(e.parent_div)};b(e.prototype,{to_dict:function(){var a=c.prototype.to_dict.call(this);return b(a,{type:"number",min:this.min,max:this.max,low:this.low,high:this.high})},copy:function(){return new e({name:this.name,index:this.index,tool_id:this.tool_id,tool_exp_name:this.tool_exp_name})},get_slider_step:function(a,b){var c=b-a;return 2>=c?.01:1},slide:function(a,b){var c=b.values;this.values_span.text(c[0]+"-"+c[1]),this.low=c[0],this.high=c[1];var d=this;setTimeout(function(){c[0]===d.low&&c[1]===d.high&&d.manager.track.request_draw({force:!0,clear_after:!0})},25)},applies_to:function(a){return a.length>this.index?!0:!1},_keep_val:function(a){return isNaN(a)||a>=this.low&&a<=this.high},keep:function(a){if(!this.applies_to(a))return!0;var b=a[this.index];if(b instanceof Array){for(var c=!0,d=0;d<b.length;d++)if(!this._keep_val(b[d])){c=!1;break}return c}return this._keep_val(a[this.index])},update_attrs:function(a){var b=!1;if(!this.applies_to(a))return b;var c=a[this.index];c instanceof Array||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d];e<this.min&&(this.min=Math.floor(e),b=!0),e>this.max&&(this.max=Math.ceil(e),b=!0)}return b},update_ui_elt:function(){this.min<this.max?this.parent_div.show():this.parent_div.hide();var a=this.slider.slider("option","min"),b=this.slider.slider("option","max");(this.min<a||this.max>b)&&(this.slider.slider("option","min",this.min),this.slider.slider("option","max",this.max),this.slider.slider("option","step",this.get_slider_step(this.min,this.max)),this.slider.slider("option","values",[this.min,this.max]))}});var f=function(a,b){if(this.track=a,this.alpha_filter=null,this.height_filter=null,this.filters=[],this.parent_div=$("<div/>").addClass("filters").hide(),this.parent_div.bind("drag",function(a){a.stopPropagation()}).click(function(a){a.stopPropagation()}).bind("dblclick",function(a){a.stopPropagation()}).bind("keydown",function(a){a.stopPropagation()}),b&&"filters"in b){for(var c,d=("alpha_filter"in b?b.alpha_filter:null),f=("height_filter"in b?b.height_filter:null),g=b.filters,h=0;h<g.length;h++)"number"===g[h].type?(c=new e(g[h]),this.add_filter(c),c.name===d&&(this.alpha_filter=c,c.transparency_icon.addClass("active").show()),c.name===f&&(this.height_filter=c,c.height_icon.addClass("active").show())):console.log("ERROR: unsupported filter: ",name,type);"visible"in b&&b.visible&&this.parent_div.show()}if(0!==this.filters.length){var i=$("<div/>").addClass("param-row").appendTo(this.parent_div),j=$("<input type='submit'/>").attr("value","Run on complete dataset").appendTo(i),k=this;j.click(function(){k.run_on_dataset()})}};return b(f.prototype,{show:function(){this.parent_div.show()},hide:function(){this.parent_div.hide()},toggle:function(){this.parent_div.toggle()},visible:function(){return this.parent_div.is(":visible")},to_dict:function(){for(var a,b={},c=[],d=0;d<this.filters.length;d++)a=this.filters[d],c.push(a.to_dict());return b.filters=c,b.alpha_filter=this.alpha_filter?this.alpha_filter.name:null,b.height_filter=this.height_filter?this.height_filter.name:null,b.visible=this.parent_div.is(":visible"),b},copy:function(a){for(var b=new f(a),c=0;c<this.filters.length;c++)b.add_filter(this.filters[c].copy());return b},add_filter:function(a){a.manager=this,this.parent_div.append(a.parent_div),this.filters.push(a)},remove_all:function(){this.filters=[],this.parent_div.children().remove()},init_filters:function(){for(var a=0;a<this.filters.length;a++){var b=this.filters[a];b.update_ui_elt()}},clear_filters:function(){for(var a=0;a<this.filters.length;a++){var b=this.filters[a];b.slider.slider("option","values",[b.min,b.max])}this.alpha_filter=null,this.height_filter=null,this.parent_div.find(".icon-button").hide()},run_on_dataset:function(){for(var a,b,c=(function(a,b,c){return b in a||(a[b]=c),a[b]}),d={},e=0;e<this.filters.length;e++)a=this.filters[e],a.tool_id&&(a.min!==a.low&&(b=c(d,a.tool_id,[]),b[b.length]=a.tool_exp_name+" >= "+a.low),a.max!==a.high&&(b=c(d,a.tool_id,[]),b[b.length]=a.tool_exp_name+" <= "+a.high));var f=[];for(var g in d)f[f.length]=[g,d[g]];!function a(b,c){var d=c[0],e=d[0],f=d[1],g="("+f.join(") and (")+")",h={cond:g,input:b,target_dataset_id:b,tool_id:e};c=c.slice(1),$.getJSON(run_tool_url,h,function(b){b.error?Galaxy.modal.show({title:"Filter Dataset",body:"Error running tool "+e,buttons:{Close:Galaxy.modal.hide()}}):0===c.length?Galaxy.modal.show({title:"Filtering Dataset",body:"Filter(s) are running on the complete dataset. Outputs are in dataset's history.",buttons:{Close:Galaxy.modal.hide()}}):a(b.dataset_id,c)})}(this.track.dataset_id,f)}}),{FiltersManager:f,NumberFilter:e}});
//# sourceMappingURL=../../../maps/viz/trackster/filters.js.map